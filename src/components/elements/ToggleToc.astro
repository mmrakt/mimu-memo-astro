---
import TocSp from './TocSp.astro'
import { TOC_WRAPPER_CLASS, TOGGLE_TOC_BUTTON_CLASS } from '../../config'
---

<div class="toggleToc">
  <button class={TOGGLE_TOC_BUTTON_CLASS} data-selector="js-toc-toggle-button">
    TOC
  </button>
  <div class={TOC_WRAPPER_CLASS} data-selector="js-toc-modal">
    <TocSp />
  </div>
</div>

<style lang="scss">
  @use '../../styles/utils' as utils;
  @use '../../styles/variables' as vars;
  .toggleToc {
    text-align: right;

    &__button {
      position: relative;
      padding-right: 40px;
      font-weight: bold;
      border: none;
      background: none;

      &::after {
        position: absolute;
        display: block;
        content: '';
        top: 25%;
        right: 20px;
        border-right: 1px solid vars.$text-color-black;
        border-bottom: 1px solid vars.$text-color-black;
        width: 10px;
        height: 10px;
        transform: rotate(45deg);
      }

      &.isOpen {
        &::after {
          transform: rotate(225deg);
          top: 40%;
        }
      }
    }
    &__body {
      display: none;
      position: absolute;
      max-height: 80vh;
      max-width: 400px;
      top: 40px;
      left: 25px;
      right: 25px;
      z-index: 100;
      margin: 0 auto;
      border-radius: 10px;
      box-shadow: 0 0 15px vars.$black-600;
      overflow-y: auto;

      &.isOpen {
        display: block;
      }
    }
  }
</style>

<script>
  import tocbot from 'tocbot'
  import { TOC_WRAPPER_CLASS, TOGGLE_TOC_BUTTON_CLASS } from '../../config'
  const isOpenClass = 'isOpen'
  const tocModalSelector = 'js-toc-modal'
  const tocToggleButton = 'js-toc-toggle-button'
  const modal = document.querySelector(`[data-selector=${tocModalSelector}]`)
  const button = document.querySelector(`[data-selector=${tocToggleButton}]`)
  const tocLinkClass = '.toc-link'

  button?.addEventListener('click', (event) => {
    if (modal?.classList.contains(isOpenClass)) {
      closeModal()
    } else {
      openModal()
    }

    document.body.addEventListener(
      'click',
      { handleEvent: closeModalByOutside },
      true
    )
  })

  const openModal = () => {
    modal?.classList.add(isOpenClass)
    button?.classList.add(isOpenClass)
  }
  const closeModal = () => {
    modal?.classList.remove(isOpenClass)
    button?.classList.remove(isOpenClass)
  }

  function closeModalByOutside(event: Event): void {
    const target = event.target as HTMLDivElement
    if (target.closest(`[data-selector=${tocModalSelector}]`) === null) {
      closeModal()
      event.stopPropagation() // button要素のイベント発火の抑制
      document.body.removeEventListener('click', this, true)
    }
  }
</script>
